---
// src/pages/login.astro
// If the user submits the form, this code runs on the server
let error = null;

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const email = data.get("email");
  const password = data.get("password");

  // Ask Strapi: "Is this user real?"
  const response = await fetch("https://sparkling-diamond-9b93a197bc.strapiapp.com/api/auth/local", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ identifier: email, password }),
  });

  const result = await response.json();

  if (result.jwt) {
    // SUCCESS! Save the "Badge" (JWT) in a cookie
    Astro.cookies.set("jwt", result.jwt, { path: "/" });
    return Astro.redirect("/dashboard"); // Send them to the dashboard
  } else {
    error = "Invalid credentials";
  }
}
---

<html lang="en">
  <body class="bg-slate-900 text-white min-h-screen flex items-center justify-center">
    <div class="bg-slate-800 p-8 rounded-lg shadow-xl w-96">
      <h1 class="text-2xl font-bold mb-6 text-center">HG Cloud Login</h1>
      
      {error && <p class="text-red-500 mb-4 text-center">{error}</p>}

      <form method="POST" class="flex flex-col gap-4">
        <label>
          Email
          <input type="email" name="email" class="w-full p-2 rounded bg-slate-700 border border-slate-600" required />
        </label>
        <label>
          Password
          <input type="password" name="password" class="w-full p-2 rounded bg-slate-700 border border-slate-600" required />
        </label>
        <button class="bg-blue-600 hover:bg-blue-500 p-2 rounded font-bold mt-2">Sign In</button>
      </form>
    </div>
  </body>
</html>